<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€å®æ—¶è¡Œæƒ…</title>
    
    <style>
        /* CSSå˜é‡å®šä¹‰ï¼Œæ–¹ä¾¿å…¨å±€ä¿®æ”¹ä¸»é¢˜é¢œè‰²å’Œæ ·å¼ */
        :root {
            --card-bg: #ffffff;
            --body-bg: #f4f6f8;
            --text-color: #333;
            --primary-color: #009879;
            --positive-color: #c0392b;
            --negative-color: #27ae60;
            --border-color: #e0e0e0;
        }

        /* é¡µé¢æ•´ä½“æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--body-bg);
            color: var(--text-color);
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ï¼Œä½¿ç”¨Gridå¸ƒå±€ */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr; /* å§‹ç»ˆä¸ºå•åˆ—å¸ƒå±€ */
            gap: 20px; /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
            max-width: 1800px;
            margin: auto;
        }

        /* å­å¡ç‰‡å®¹å™¨ï¼Œç”¨äºåœ¨ç¬¬äºŒè¡Œå¹¶æ’æ˜¾ç¤ºä¸¤ä¸ªå°å¡ç‰‡ */
        .sub-card-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        /* å½“å±å¹•å®½åº¦å¤§äº992pxæ—¶ï¼Œå­å¡ç‰‡å®¹å™¨å˜ä¸ºä¸¤åˆ—å‡åˆ†å¸ƒå±€ */
        @media (min-width: 992px) {
            .sub-card-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* å¡ç‰‡çš„é€šç”¨æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* å¡ç‰‡æ ‡é¢˜æ ·å¼ */
        .card h2, .card h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        /* é¡¶éƒ¨æ§åˆ¶æ æ ·å¼ */
        .controls {
            display: flex;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        .controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å­å¡ç‰‡æ§åˆ¶æ æ ·å¼ */
        .sub-card-controls {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sub-card-controls label {
            font-weight: 500;
        }

        /* çŠ¶æ€ä¿¡æ¯æ æ ·å¼ */
        .status-bar {
            padding: 5px 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        .status-on { background-color: #e8f5e9; color: #2e7d32; }
        .status-off { background-color: #fff3e0; color: #ef6c00; }
        .status-error { background-color: #ffebee; color: #c62828; }

        /* åˆ—é€‰æ‹©å™¨UIç¾åŒ– */
        .dropdown-check-list {
            position: relative;
        }
        .dropdown-check-list .anchor {
            position: relative;
            cursor: pointer;
            padding: 8px 50px 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
        }
        .dropdown-check-list .anchor:after {
            content: "";
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #000;
            position: absolute;
            right: 15px;
            top: calc(50% - 2.5px);
        }
        .dropdown-check-list ul.items {
            display: none;
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 2px 0 0 0;
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 300px;
            column-count: 2;
            column-gap: 10px;
        }
        .dropdown-check-list.visible ul.items {
            display: block;
        }
        .dropdown-check-list ul.items li {
            padding: 5px;
            display: block;
            break-inside: avoid;
        }
        .dropdown-check-list ul.items li label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®æ ·å¼ */
        #manual-refresh-btn {
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }
        #manual-refresh-btn:hover {
            background-color: #007a63;
        }
        #manual-refresh-btn:disabled {
            background-color: #95a5a6;
            border-color: #95a5a6;
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* --- å…¶ä»–é€šç”¨æ ·å¼ --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        thead tr { background-color: var(--primary-color); color: #ffffff; text-align: left; }
        th, td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: right; white-space: nowrap; }
        th:nth-child(1), th:nth-child(2), td:nth-child(1), td:nth-child(2) { text-align: left; }
        tbody tr:nth-of-type(even) { background-color: #f9f9f9; }
        .positive { color: var(--positive-color); font-weight: 500; }
        .negative { color: var(--negative-color); font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:focus + .slider { box-shadow: 0 0 1px #27ae60; }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>

<body>
    <div class="dashboard">
        <div class="card main-card">
            <h2>å®æ—¶æ•°æ®æ€»è§ˆ</h2>
            
            <div class="controls">
                <div>
                    <label for="search-box">æœç´¢:</label>
                    <input type="search" id="search-box" placeholder="è¾“å…¥ä»£ç æˆ–åç§°...">
                </div>
                <div>
                    <label>æ˜¾ç¤ºåˆ—:</label>
                    <div id="column-selector" class="dropdown-check-list">
                        <span class="anchor">é€‰æ‹©åˆ—</span>
                        <ul class="items"></ul>
                    </div>
                </div>
                <div>
                    <label for="refresh-rate">åˆ·æ–°é¢‘ç‡:</label>
                    <select id="refresh-rate">
                        <option value="60000">1 åˆ†é’Ÿ</option>
                        <option value="180000" selected>3 åˆ†é’Ÿ</option>
                        <option value="300000">5 åˆ†é’Ÿ</option>
                    </select>
                </div>
                <div>
                    <label for="page-size">æ¯é¡µæ˜¾ç¤º:</label>
                    <select id="page-size">
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div>
                    <label>è‡ªåŠ¨åˆ·æ–°:</label>
                    <label class="switch">
                        <input type="checkbox" id="auto-refresh-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div>
                    <button id="manual-refresh-btn">&#x21bb; æ‰‹åŠ¨åˆ·æ–°</button>
                </div>
            </div>

            <div id="status-bar" class="status-bar"></div>

            <div class="table-container">
                <table>
                    <thead id="table-head"></thead>
                    <tbody id="table-body">
                        <tr><td colspan="7" style="text-align:center; padding: 40px;">æ­£åœ¨åˆå§‹åŒ–...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div>
            <div class="sub-card-controls">
                <label for="sub-card-page-size">æ¦œå•æ˜¾ç¤ºé¡¹æ•°:</label>
                <select id="sub-card-page-size">
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                </select>
            </div>
            <div class="sub-card-container">
                <div class="card">
                    <h3 id="speed-card-title">ğŸš€ æ¶¨é€Ÿæ¦œ</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>åç§°</th>
                                    <th>æ¶¨é€Ÿ(%)</th>
                                    <th>æœ€æ–°ä»·</th>
                                    <th>æ¶¨è·Œå¹…(%)</th>
                                </tr>
                            </thead>
                            <tbody id="speed-card-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 id="5min-card-title">â±ï¸ 5åˆ†é’Ÿæ¶¨è·Œæ¦œ</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>åç§°</th>
                                    <th>5åˆ†é’Ÿæ¶¨è·Œ(%)</th>
                                    <th>æœ€æ–°ä»·</th>
                                    <th>æ¶¨è·Œå¹…(%)</th>
                                </tr>
                            </thead>
                            <tbody id="5min-change-card-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å½“æ•´ä¸ªHTMLæ–‡æ¡£åŠ è½½å¹¶è§£æå®Œæˆåï¼Œæ‰§è¡Œæ­¤å‡½æ•°
        document.addEventListener('DOMContentLoaded', function() {
            // --- å…¨å±€å˜é‡å’ŒçŠ¶æ€ç®¡ç† ---
            
            // ç”¨äºå­˜å‚¨ä»APIè·å–çš„å…¨éƒ¨è‚¡ç¥¨æ•°æ®
            let allStockData = [];
            // ç”¨äºå­˜å‚¨è‡ªåŠ¨åˆ·æ–°çš„å®šæ—¶å™¨IDï¼Œæ–¹ä¾¿åç»­æ¸…é™¤
            let refreshTimerId = null;

            // åº”ç”¨çš„é™æ€é…ç½®
            const config = {
                api: '/api/data', // åç«¯æ•°æ®æ¥å£åœ°å€
                // å®šä¹‰æ‰€æœ‰åˆ—çš„keyå’Œå¯¹åº”çš„ä¸­æ–‡åç§°
                columns: {
                    symbol: "ä»£ç ", name: "åç§°", latest_price: "æœ€æ–°ä»·",
                    change_percent: "æ¶¨è·Œå¹…(%)", change_amount: "æ¶¨è·Œé¢", volume: "æˆäº¤é‡(æ‰‹)",
                    turnover: "æˆäº¤é¢(å…ƒ)", amplitude: "æŒ¯å¹…(%)", high: "æœ€é«˜",
                    low: "æœ€ä½", open: "ä»Šå¼€", previous_close: "æ˜¨æ”¶",
                    volume_ratio: "é‡æ¯”", turnover_rate: "æ¢æ‰‹ç‡(%)", pe_ratio: "å¸‚ç›ˆç‡",
                    pb_ratio: "å¸‚å‡€ç‡", market_cap_total: "æ€»å¸‚å€¼", market_cap_float: "æµé€šå¸‚å€¼",
                    speed_increase: "æ¶¨é€Ÿ(%)", change_5min: "5åˆ†é’Ÿæ¶¨è·Œ(%)", change_60day: "60æ—¥æ¶¨è·Œå¹…(%)",
                    change_ytd: "å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…(%)"
                },
                // ä¸»è¡¨æ ¼é»˜è®¤æ˜¾ç¤ºçš„åˆ—
                defaultVisibleColumns: ["symbol", "name", "latest_price", "change_percent", "change_amount", "volume", "turnover"]
            };

            // åº”ç”¨çš„åŠ¨æ€çŠ¶æ€ï¼Œå­˜å‚¨ç”¨æˆ·çš„è®¾ç½®å’ŒUIçŠ¶æ€
            const state = {
                searchTerm: '', // æœç´¢æ¡†å†…å®¹
                refreshRate: 180000, // åˆ·æ–°é¢‘ç‡(æ¯«ç§’)
                pageSize: 10, // ä¸»å¡ç‰‡é»˜è®¤æ˜¾ç¤º10é¡¹
                subCardPageSize: 10, // å­å¡ç‰‡é»˜è®¤æ˜¾ç¤º10é¡¹
                visibleColumns: new Set(config.defaultVisibleColumns), // å½“å‰å¯è§çš„åˆ—
                isAutoRefreshOn: false // è‡ªåŠ¨åˆ·æ–°æ˜¯å¦å¼€å¯
            };

            // --- è·å–é¡µé¢ä¸Šçš„HTMLå…ƒç´ ï¼Œæ–¹ä¾¿åç»­æ“ä½œ ---
            const searchBox = document.getElementById('search-box');
            const refreshRateSelector = document.getElementById('refresh-rate');
            const pageSizeSelector = document.getElementById('page-size');
            const tableHead = document.getElementById('table-head');
            const tableBody = document.getElementById('table-body');
            const columnSelector = document.getElementById('column-selector');
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            const statusBar = document.getElementById('status-bar');
            const speedCardBody = document.getElementById('speed-card-body');
            const fiveMinChangeCardBody = document.getElementById('5min-change-card-body');
            const manualRefreshBtn = document.getElementById('manual-refresh-btn');
            const subCardPageSizeSelector = document.getElementById('sub-card-page-size');
            const speedCardTitle = document.getElementById('speed-card-title');
            const fiveMinCardTitle = document.getElementById('5min-card-title');

            // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

            // å‡½æ•°ï¼šåˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºAè‚¡å¼€å¸‚æ—¶é—´ (ä¸œå…«åŒº)
            function isTradingHours() {
                const now = new Date();
                const cstString = now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' });
                const cstDate = new Date(cstString);
                const dayOfWeek = cstDate.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
                if (dayOfWeek === 0 || dayOfWeek === 6) { return false; } // å‘¨æœ«ä¼‘å¸‚
                const hours = cstDate.getHours();
                const minutes = cstDate.getMinutes();
                const currentTimeInMinutes = hours * 60 + minutes;
                const marketOpenInMinutes = 9 * 60 + 15; // 9:15
                const marketCloseInMinutes = 15 * 60; // 15:00
                return currentTimeInMinutes >= marketOpenInMinutes && currentTimeInMinutes <= marketCloseInMinutes;
            }

            // å‡½æ•°ï¼šæ›´æ–°é¡¶éƒ¨çš„çŠ¶æ€ä¿¡æ¯æ 
            function updateStatusMessage(message, type) {
                statusBar.textContent = message;
                statusBar.className = 'status-bar'; // å…ˆé‡ç½®æ ·å¼
                if (type === 'on') { statusBar.classList.add('status-on'); }
                else if (type === 'off') { statusBar.classList.add('status-off'); }
                else if (type === 'error') { statusBar.classList.add('status-error'); }
            }

            // å‡½æ•°ï¼šè°ƒåº¦ä¸‹ä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°
            function scheduleNextFetch() {
                clearTimeout(refreshTimerId); // æ€»æ˜¯å…ˆæ¸…é™¤æ—§çš„å®šæ—¶å™¨
                if (!state.isAutoRefreshOn) return; // å¦‚æœå¼€å…³å…³é—­ï¼Œåˆ™ç›´æ¥é€€å‡º
                // éšæœºå¢åŠ 5-10ç§’çš„æŠ–åŠ¨ï¼Œé¿å…è§„å¾‹æ€§è¯·æ±‚
                const jitter = Math.random() * 5000 + 5000;
                const nextFetchDelay = state.refreshRate + jitter;
                const minutes = Math.floor(nextFetchDelay / 60000);
                const seconds = Math.round((nextFetchDelay % 60000) / 1000);
                updateStatusMessage(`è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ã€‚ä¸‹ä¸€æ¬¡åˆ·æ–°å°†åœ¨çº¦ ${minutes}åˆ† ${seconds}ç§’ å`, 'on');
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨å»¶è¿Ÿåæ‰§è¡Œæ•°æ®è·å–
                refreshTimerId = setTimeout(async () => {
                    await fetchData();
                    // åœ¨æ•°æ®è·å–å®Œæˆåï¼Œå¦‚æœå¼€å…³ä»ç„¶æ˜¯å¼€å¯çŠ¶æ€ï¼Œåˆ™å†æ¬¡è°ƒç”¨æœ¬å‡½æ•°ï¼Œå½¢æˆå¾ªç¯
                    if(state.isAutoRefreshOn) { scheduleNextFetch(); }
                }, nextFetchDelay);
            }

            // å‡½æ•°ï¼šåˆå§‹åŒ–åˆ—é€‰æ‹©å™¨ä¸‹æ‹‰èœå•
            function initializeColumnSelector() {
                const itemsList = columnSelector.querySelector('.items');
                for (const key in config.columns) {
                    const li = document.createElement('li');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${key}`;
                    checkbox.value = key;
                    checkbox.checked = state.visibleColumns.has(key); // æ ¹æ®stateè®¾ç½®åˆå§‹é€‰ä¸­çŠ¶æ€
                    checkbox.addEventListener('change', (e) => { // ç›‘å¬å‹¾é€‰å˜åŒ–
                        if (e.target.checked) { state.visibleColumns.add(key); }
                        else { state.visibleColumns.delete(key); }
                        renderMainTable(); // é‡æ–°æ¸²æŸ“ä¸»è¡¨æ ¼
                    });
                    const label = document.createElement('label');
                    label.htmlFor = `col-${key}`;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(` ${config.columns[key]}`));
                    li.appendChild(label);
                    itemsList.appendChild(li);
                }
                // æ§åˆ¶ä¸‹æ‹‰èœå•çš„æ˜¾ç¤ºå’Œéšè—
                const anchor = columnSelector.querySelector('.anchor');
                anchor.addEventListener('click', () => { columnSelector.classList.toggle('visible'); });
                document.addEventListener('click', (e) => { if (!columnSelector.contains(e.target)) { columnSelector.classList.remove('visible'); }});
            }

            // å‡½æ•°ï¼šæ ¼å¼åŒ–å•å…ƒæ ¼æ•°æ®ï¼Œä½¿å…¶æ˜¾ç¤ºæ›´å‹å¥½
            function formatCell(key, value) {
                if (value === null || value === undefined) return 'N/A';
                if (typeof value === 'number') {
                    if (key.includes('percent') || key.includes('rate') || key.includes('amplitude') || key.includes('speed') || key.includes('ratio') || key.includes('change_5min')) {
                        return value.toFixed(2) + '%';
                    }
                    if (key === 'volume') { return (value / 100).toFixed(0); } // æˆäº¤é‡è½¬ä¸º "æ‰‹"
                    if (key === 'turnover' || key.includes('market_cap')) { // æˆäº¤é¢å’Œå¸‚å€¼è½¬ä¸º "ä¸‡" æˆ– "äº¿"
                        if (value > 1e8) return (value / 1e8).toFixed(2) + 'äº¿';
                        if (value > 1e4) return (value / 1e4).toFixed(2) + 'ä¸‡';
                    }
                    return value.toFixed(2);
                }
                return value;
            }

            // å‡½æ•°ï¼šæ¸²æŸ“ä¸¤ä¸ªå­å¡ç‰‡ï¼ˆæ¶¨é€Ÿæ¦œå’Œ5åˆ†é’Ÿæ¶¨è·Œæ¦œï¼‰
            function renderSubCards() {
                if (allStockData.length === 0) return;
                const itemCount = state.subCardPageSize;

                // æ¸²æŸ“æ¶¨é€Ÿæ¦œ
                const sortedBySpeed = allStockData.slice().sort((a, b) => (b.speed_increase || -Infinity) - (a.speed_increase || -Infinity));
                const topItemsSpeed = sortedBySpeed.slice(0, itemCount);
                let speedCardHTML = '';
                topItemsSpeed.forEach(stock => {
                    speedCardHTML += `<tr><td>${stock.symbol}</td><td>${stock.name}</td><td class="${stock.speed_increase > 0 ? 'positive' : stock.speed_increase < 0 ? 'negative' : ''}">${formatCell('speed_increase', stock.speed_increase)}</td><td class="${stock.change_amount > 0 ? 'positive' : stock.change_amount < 0 ? 'negative' : ''}">${formatCell('latest_price', stock.latest_price)}</td><td class="${stock.change_percent > 0 ? 'positive' : stock.change_percent < 0 ? 'negative' : ''}">${formatCell('change_percent', stock.change_percent)}</td></tr>`;
                });
                speedCardBody.innerHTML = speedCardHTML || `<tr><td colspan="5" style="text-align:center;">æš‚æ— æ•°æ®</td></tr>`;

                // æ¸²æŸ“5åˆ†é’Ÿæ¶¨è·Œæ¦œ
                const sortedBy5Min = allStockData.slice().sort((a, b) => (b.change_5min || -Infinity) - (a.change_5min || -Infinity));
                const topItems5Min = sortedBy5Min.slice(0, itemCount);
                let fiveMinCardHTML = '';
                topItems5Min.forEach(stock => {
                    fiveMinCardHTML += `<tr><td>${stock.symbol}</td><td>${stock.name}</td><td class="${stock.change_5min > 0 ? 'positive' : stock.change_5min < 0 ? 'negative' : ''}">${formatCell('change_5min', stock.change_5min)}</td><td class="${stock.change_amount > 0 ? 'positive' : stock.change_amount < 0 ? 'negative' : ''}">${formatCell('latest_price', stock.latest_price)}</td><td class="${stock.change_percent > 0 ? 'positive' : stock.change_percent < 0 ? 'negative' : ''}">${formatCell('change_percent', stock.change_percent)}</td></tr>`;
                });
                fiveMinChangeCardBody.innerHTML = fiveMinCardHTML || `<tr><td colspan="5" style="text-align:center;">æš‚æ— æ•°æ®</td></tr>`;

                // æ›´æ–°æ¦œå•æ ‡é¢˜
                speedCardTitle.textContent = `ğŸš€ æ¶¨é€Ÿæ¦œ Top ${itemCount}`;
                fiveMinCardTitle.textContent = `â±ï¸ 5åˆ†é’Ÿæ¶¨è·Œæ¦œ Top ${itemCount}`;
            }

            // å‡½æ•°ï¼šæ¸²æŸ“ä¸»æ•°æ®è¡¨æ ¼
            function renderMainTable() {
                // æ¸²æŸ“è¡¨å¤´
                let headerHTML = '<tr>';
                for (const colKey of state.visibleColumns) { headerHTML += `<th>${config.columns[colKey] || colKey}</th>`; }
                headerHTML += '</tr>';
                tableHead.innerHTML = headerHTML;

                // æ ¹æ®æœç´¢è¯è¿‡æ»¤æ•°æ®
                const lowerSearchTerm = state.searchTerm.toLowerCase();
                const filteredData = allStockData.filter(stock => stock.symbol.toLowerCase().includes(lowerSearchTerm) || stock.name.toLowerCase().includes(lowerSearchTerm));
                
                // æ ¹æ®åˆ†é¡µè®¾ç½®æˆªå–æ•°æ®
                const paginatedData = filteredData.slice(0, state.pageSize);

                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (paginatedData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${state.visibleColumns.size}" style="text-align:center; padding: 40px;">æ²¡æœ‰åŒ¹é…çš„æ•°æ®</td></tr>`;
                    return;
                }
                
                // æ¸²æŸ“è¡¨ä½“
                let bodyHTML = '';
                paginatedData.forEach(stock => {
                    bodyHTML += '<tr>';
                    for (const colKey of state.visibleColumns) {
                        const value = stock[colKey];
                        let className = '';
                        if (colKey === 'latest_price' || colKey === 'change_percent' || colKey === 'change_amount') {
                            if (stock.change_amount > 0) className = 'positive';
                            else if (stock.change_amount < 0) className = 'negative';
                        }
                        bodyHTML += `<td class="${className}">${formatCell(colKey, value)}</td>`;
                    }
                    bodyHTML += '</tr>';
                });
                tableBody.innerHTML = bodyHTML;
            }

            // å‡½æ•°ï¼šä»åç«¯APIè·å–æ•°æ®
            async function fetchData() {
                try {
                    const response = await fetch(config.api);
                    if (!response.ok) { throw new Error(`ç½‘ç»œé”™è¯¯! çŠ¶æ€ç : ${response.status}`); }
                    allStockData = await response.json();
                    // è·å–æˆåŠŸåï¼Œæ¸²æŸ“æ‰€æœ‰ç›¸å…³çš„UIéƒ¨åˆ†
                    renderMainTable();
                    renderSubCards();
                } catch (error) {
                    console.error("è·å–æ•°æ®å¤±è´¥:", error);
                    // å¦‚æœè·å–å¤±è´¥ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    state.isAutoRefreshOn = false;
                    autoRefreshToggle.checked = false;
                    clearTimeout(refreshTimerId);
                    updateStatusMessage(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message} è‡ªåŠ¨åˆ·æ–°å·²æš‚åœã€‚`, 'error');
                }
            }

            // --- äº‹ä»¶ç›‘å¬å™¨ç»‘å®š ---
            // ç›‘å¬æœç´¢æ¡†çš„è¾“å…¥äº‹ä»¶
            searchBox.addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                renderMainTable(); // åªæ›´æ–°ä¸»è¡¨æ ¼
            });

            // ç›‘å¬ä¸»è¡¨æ ¼åˆ†é¡µå¤§å°é€‰æ‹©å™¨çš„å˜åŒ–
            pageSizeSelector.addEventListener('change', (e) => {
                state.pageSize = parseInt(e.target.value, 10);
                renderMainTable(); // åªæ›´æ–°ä¸»è¡¨æ ¼
            });
            
            // ç›‘å¬å­å¡ç‰‡åˆ†é¡µå¤§å°é€‰æ‹©å™¨çš„å˜åŒ–
            subCardPageSizeSelector.addEventListener('change', (e) => {
                state.subCardPageSize = parseInt(e.target.value, 10);
                renderSubCards(); // åªé‡æ–°æ¸²æŸ“å­å¡ç‰‡
            });

            // ç›‘å¬åˆ·æ–°é¢‘ç‡é€‰æ‹©å™¨çš„å˜åŒ–
            refreshRateSelector.addEventListener('change', (e) => {
                state.refreshRate = parseInt(e.target.value, 10);
                scheduleNextFetch(); // é‡æ–°å®‰æ’ä¸‹ä¸€æ¬¡åˆ·æ–°
            });

            // ç›‘å¬è‡ªåŠ¨åˆ·æ–°å¼€å…³çš„å˜åŒ–
            autoRefreshToggle.addEventListener('change', (e) => {
                state.isAutoRefreshOn = e.target.checked;
                if (state.isAutoRefreshOn) {
                    updateStatusMessage('æ­£åœ¨å¯åŠ¨è‡ªåŠ¨åˆ·æ–°...', 'on');
                    fetchData(); // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
                    scheduleNextFetch(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°å¾ªç¯
                } else {
                    clearTimeout(refreshTimerId); // æ¸…é™¤å®šæ—¶å™¨ä»¥åœæ­¢
                    updateStatusMessage('è‡ªåŠ¨åˆ·æ–°å·²ç”±ç”¨æˆ·å…³é—­ã€‚', 'off');
                }
            });

            // ç›‘å¬æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            manualRefreshBtn.addEventListener('click', async () => {
                manualRefreshBtn.disabled = true; // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                manualRefreshBtn.textContent = 'æ­£åœ¨åˆ·æ–°...';
                updateStatusMessage('æ­£åœ¨æ‰‹åŠ¨åˆ·æ–°æ•°æ®...', 'on');
                
                await fetchData(); // ç­‰å¾…æ•°æ®è·å–å®Œæˆ
                
                manualRefreshBtn.disabled = false; // æ¢å¤æŒ‰é’®
                manualRefreshBtn.innerHTML = '&#x21bb; æ‰‹åŠ¨åˆ·æ–°';
                // å¦‚æœè‡ªåŠ¨åˆ·æ–°æ˜¯å…³é—­çš„ï¼Œåˆ·æ–°åæç¤ºä¸€ä¸‹
                if (!state.isAutoRefreshOn) {
                    updateStatusMessage('æ‰‹åŠ¨åˆ·æ–°å®Œæˆã€‚è‡ªåŠ¨åˆ·æ–°å½“å‰ä¸ºå…³é—­çŠ¶æ€ã€‚', 'off');
                }
            });

            // --- åº”ç”¨åˆå§‹åŒ–å‡½æ•° ---
            function init() {
                initializeColumnSelector(); // åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨
                // æ ¹æ®æ˜¯å¦ä¸ºå¼€å¸‚æ—¶é—´ï¼Œå†³å®šè‡ªåŠ¨åˆ·æ–°çš„åˆå§‹çŠ¶æ€
                if (isTradingHours()) {
                    state.isAutoRefreshOn = true;
                    autoRefreshToggle.checked = true;
                    fetchData(); // ç«‹å³è·å–æ•°æ®
                    scheduleNextFetch(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
                } else {
                    state.isAutoRefreshOn = false;
                    autoRefreshToggle.checked = false;
                    updateStatusMessage('å½“å‰ä¸ºéå¼€å¸‚æ—¶é—´ï¼Œè‡ªåŠ¨åˆ·æ–°å·²å…³é—­ã€‚', 'off');
                    fetchData(); // éå¼€å¸‚ä¹ŸåŠ è½½ä¸€æ¬¡æ•°æ®
                }
            }

            // æ‰§è¡Œåˆå§‹åŒ–
            init();
        });
    </script>
</body>
</html>